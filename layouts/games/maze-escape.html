{{ define "styles" }}
  <style>
    .game-maze-escape {
      color: #0f172a;
      background:
        radial-gradient(900px circle at 75% -260px, rgba(14,116,144,0.35), transparent 60%),
        radial-gradient(900px circle at 18% 120%, rgba(250,204,21,0.3), transparent 60%),
        linear-gradient(180deg, #ecfeff, #fef9c3 60%, #f8fafc);
      --card-bg: linear-gradient(145deg, rgba(255,255,255,0.92), rgba(224,231,255,0.55));
      --card-border: rgba(14,116,144,0.18);
      --card-shadow: 0 32px 95px rgba(14,116,144,0.16);
      --status-border: rgba(14,116,144,0.18);
      --status-bg: rgba(14,116,144,0.08);
      --status-color: #0f172a;
      --status-ok-bg: rgba(34,197,94,0.16);
      --status-ok-border: rgba(34,197,94,0.32);
      --status-ok-color: #065f46;
      --status-bad-bg: rgba(248,113,113,0.16);
      --status-bad-border: rgba(248,113,113,0.32);
      --status-bad-color: #991b1b;
      --status-badge-bg: rgba(14,116,144,0.2);
      --status-badge-color: #0f172a;
      --status-ok-badge-bg: rgba(34,197,94,0.9);
      --status-ok-badge-color: #fff;
      --status-bad-badge-bg: rgba(248,113,113,0.9);
      --status-bad-badge-color: #fff;
      --overlay-panel-bg: rgba(255,255,255,0.95);
      --overlay-panel-color: #0f172a;
      --overlay-action-primary: #0e7490;
      --letter-radius: 18px;
      --letter-gap: clamp(10px, 3.2vw, 20px);
      --letter-border-width: 2px;
      --letter-border-style: solid;
      --letter-border-color: rgba(14,116,144,0.28);
      --letter-color: rgba(14,116,144,0.8);
      --letter-filled-border-color: rgba(14,116,144,0.4);
      --letter-filled-bg: rgba(255,255,255,0.8);
      --letter-filled-color: #0f172a;
    }
    .game-maze-escape.win-mode {
      background:
        radial-gradient(900px circle at 60% -200px, rgba(250,204,21,0.65), transparent 60%),
        radial-gradient(900px circle at 15% 120%, rgba(129,231,250,0.65), transparent 60%),
        linear-gradient(180deg, rgba(254,249,195,1), rgba(224,231,255,0.95));
    }
    .maze-board {
      display: grid;
      grid-template-columns: repeat(var(--maze-cols, 11), minmax(0, 1fr));
      gap: 6px;
      padding: 16px;
      width: min(100%, 520px);
      margin: 0 auto;
      border-radius: 28px;
      background: rgba(255,255,255,0.7);
      border: 2px solid rgba(14,116,144,0.2);
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.8);
    }
    .maze-cell {
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-size: clamp(16px, 4vw, 22px);
      font-weight: 800;
      text-transform: uppercase;
      color: #0f172a;
      background: rgba(226,232,240,0.7);
      border: 2px solid rgba(148,163,184,0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .maze-cell.wall {
      background: linear-gradient(145deg, rgba(15,23,42,0.85), rgba(30,41,59,0.95));
      border-color: rgba(15,23,42,0.6);
      box-shadow: inset 0 2px 4px rgba(15,23,42,0.6);
    }
    .maze-cell.path {
      background: rgba(226,232,240,0.9);
    }
    .maze-cell.goal {
      background: linear-gradient(145deg, rgba(250,204,21,0.35), rgba(253,224,71,0.9));
      border-color: rgba(202,138,4,0.4);
      color: #854d0e;
    }
    .maze-cell.player {
      background: linear-gradient(145deg, rgba(14,116,144,0.25), rgba(14,116,144,0.6));
      border-color: rgba(14,116,144,0.5);
      color: #f8fafc;
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 12px 25px rgba(14,116,144,0.25);
    }
    .dpad {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      max-width: 240px;
      margin: 0 auto;
    }
    .dpad-btn {
      border-radius: 18px;
      padding: 12px 0;
      border: 2px solid rgba(14,116,144,0.3);
      background: rgba(224,231,255,0.8);
      color: #0f172a;
      font-weight: 800;
      font-size: 1.2rem;
      box-shadow: 0 10px 25px rgba(14,116,144,0.18);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .dpad-btn:active {
      transform: translateY(2px) scale(0.98);
      box-shadow: 0 6px 18px rgba(14,116,144,0.22);
    }
    .dpad-placeholder {
      visibility: hidden;
    }
    .game-maze-escape .letter-row {
      justify-content: center;
    }
    .game-maze-escape .letter-box {
      font-size: 1.2rem;
      font-weight: 800;
      background: rgba(255,255,255,0.85);
    }
    .celebration {
      padding: 24px 20px;
      border-radius: 32px;
      border: 3px solid rgba(14,116,144,0.28);
      background: linear-gradient(145deg, rgba(250,204,21,0.92), rgba(224,231,255,0.9));
      box-shadow: 0 30px 70px rgba(14,116,144,0.22);
      display: grid;
      gap: 10px;
      justify-items: center;
      animation: bannerPop 0.6s ease;
      text-align: center;
    }
  </style>
{{ end }}

{{ define "body_class" }}game-page game-maze-escape text-slate-900{{ end }}

{{ define "main" }}
  <main id="mainContent" class="game-shell text-slate-900">
    <header class="game-hero">
      <h1 class="flex items-center justify-center gap-2 text-3xl font-extrabold tracking-tight sm:text-5xl">
        <span aria-hidden="true">üß©</span>
        <span>Maze Escape</span>
      </h1>
      <p class="mx-auto max-w-2xl text-sm text-slate-600 sm:text-base">
        Use the arrow keys to guide the explorer through the maze and reach the flag.
      </p>
    </header>

    <section class="game-card space-y-6" style="--card-shadow-current: 0 32px 110px rgba(14,116,144,0.16); --card-border-current: rgba(14,116,144,0.22);">
      <div class="grid grid-cols-1 gap-3 md:grid-cols-[minmax(0,1fr)_auto] md:items-end">
        <div class="space-y-3">
          <div class="text-sm font-semibold text-slate-700">Arrow Keys</div>
          <div id="arrowRow" class="letter-row" role="list" aria-label="Arrow key directions" style="--letters: 4;">
            <div class="letter-box" role="listitem">‚Üë</div>
            <div class="letter-box" role="listitem">‚Üê</div>
            <div class="letter-box" role="listitem">‚Üì</div>
            <div class="letter-box" role="listitem">‚Üí</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3 md:grid-cols-[auto_auto]">
          <button id="startBtn" class="inline-flex min-w-[9.5rem] w-full items-center justify-center rounded-2xl bg-cyan-400 px-4 py-3 text-base font-extrabold text-slate-900 shadow-xl shadow-cyan-900/15 ring-2 ring-cyan-300/70 transition hover:bg-cyan-500 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-cyan-200">Start</button>
          <button id="resetBtn" class="inline-flex min-w-[9.5rem] w-full items-center justify-center rounded-2xl border-2 border-cyan-200 bg-white/90 px-4 py-3 text-base font-extrabold text-slate-900 shadow-xl shadow-cyan-900/10 transition hover:bg-cyan-50 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-cyan-200" style="display:none;">Play again</button>
        </div>
      </div>
      <div id="status" class="status-banner" role="status" aria-live="polite" aria-atomic="true">
        <span class="status-badge" id="statusBadge">i</span>
        <span id="statusText">Press Start, then use the arrow keys to explore the maze.</span>
      </div>
    </section>

    <section id="gameArea" class="game-card space-y-8" style="display:none; --card-shadow-current: 0 36px 120px rgba(250,204,21,0.2); --card-border-current: rgba(250,204,21,0.3);" aria-live="polite">
      <div class="maze-board" id="mazeBoard" aria-label="Maze board"></div>
      <div class="space-y-4">
        <div class="text-sm font-semibold text-slate-700 text-center">Tap to move (for touch screens)</div>
        <div class="dpad" role="group" aria-label="Move controls">
          <span class="dpad-placeholder" aria-hidden="true"></span>
          <button class="dpad-btn" data-dir="up" aria-label="Move up">‚Üë</button>
          <span class="dpad-placeholder" aria-hidden="true"></span>
          <button class="dpad-btn" data-dir="left" aria-label="Move left">‚Üê</button>
          <button class="dpad-btn" data-dir="down" aria-label="Move down">‚Üì</button>
          <button class="dpad-btn" data-dir="right" aria-label="Move right">‚Üí</button>
        </div>
      </div>
    </section>

    <div id="celebrate" aria-live="polite"></div>

    <audio id="soundMove" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
    <audio id="soundWall" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
    <audio id="soundWin" src="https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg" preload="auto"></audio>
  </main>
{{ end }}

{{ define "footer" }}{{ end }}

{{ define "scripts" }}
  <script>
    (() => {
      const MAZES = [
        [
          '###########',
          '#S#.....#G#',
          '#.#.###.#.#',
          '#.#...#.#.#',
          '#.###.#.#.#',
          '#.....#...#',
          '###.#####.#',
          '#...#.....#',
          '#.#.#.###.#',
          '#...#.....#',
          '###########'
        ],
        [
          '###########',
          '#S..#.....#',
          '#.#.#.###.#',
          '#.#...#...#',
          '#.###.#.###',
          '#...#.#...#',
          '###.#.###.#',
          '#...#...#G#',
          '#.#####.#.#',
          '#.......#.#',
          '###########'
        ],
        [
          '###########',
          '#S....#...#',
          '###.#.#.#.#',
          '#...#.#.#.#',
          '#.###.#.#.#',
          '#.#...#...#',
          '#.#.###.###',
          '#.#.....#G#',
          '#.#######.#',
          '#.........#',
          '###########'
        ],
        [
          '###########',
          '#S#.......#',
          '#.#.#####.#',
          '#.#.....#.#',
          '#.###.#.#.#',
          '#...#.#.#.#',
          '###.#.#.#.#',
          '#...#.#...#',
          '#.###.###.#',
          '#.......#G#',
          '###########'
        ],
        [
          '###########',
          '#S#.....#.#',
          '#.#.###.#.#',
          '#.#.#...#.#',
          '#.#.#.###.#',
          '#...#.....#',
          '###.#####.#',
          '#.....#...#',
          '#.###.#.#G#',
          '#.....#...#',
          '###########'
        ]
      ];

      const startBtn = document.getElementById('startBtn');
      const resetBtn = document.getElementById('resetBtn');
      const status = document.getElementById('status');
      const statusBadge = document.getElementById('statusBadge');
      const statusText = document.getElementById('statusText');
      const gameArea = document.getElementById('gameArea');
      const mazeBoard = document.getElementById('mazeBoard');
      const celebrate = document.getElementById('celebrate');
      const arrowRow = document.getElementById('arrowRow');

      const soundMove = document.getElementById('soundMove');
      const soundWall = document.getElementById('soundWall');
      const soundWin = document.getElementById('soundWin');

      let active = false;
      let moves = 0;
      let mazeMap = MAZES[0];
      let start = { row: 0, col: 0 };
      let goal = { row: 0, col: 0 };
      let player = { row: 0, col: 0 };

      function pickMaze(){
        const choice = MAZES[Math.floor(Math.random() * MAZES.length)];
        mazeMap = choice;
      }

      function findPoints(){
        mazeMap.forEach((row, rowIndex) => {
          const startIndex = row.indexOf('S');
          const goalIndex = row.indexOf('G');
          if(startIndex >= 0){
            start = { row: rowIndex, col: startIndex };
          }
          if(goalIndex >= 0){
            goal = { row: rowIndex, col: goalIndex };
          }
        });
      }

      function setStatus(kind, message){
        statusText.innerHTML = message;
        status.classList.remove('ok', 'bad');
        statusBadge.textContent = 'i';
        if(kind === 'ok'){
          status.classList.add('ok');
          statusBadge.textContent = '‚úì';
        } else if(kind === 'bad'){
          status.classList.add('bad');
          statusBadge.textContent = '√ó';
        }
        status.style.display = 'flex';
      }

      function renderMaze(){
        mazeBoard.innerHTML = '';
        const rows = mazeMap.length;
        const cols = mazeMap[0].length;
        mazeBoard.style.setProperty('--maze-cols', cols);
        for(let r = 0; r < rows; r++){
          for(let c = 0; c < cols; c++){
            const cell = document.createElement('div');
            const tile = mazeMap[r][c];
            cell.className = 'maze-cell';
            if(tile === '#'){
              cell.classList.add('wall');
            } else {
              cell.classList.add('path');
            }
            if(r === goal.row && c === goal.col){
              cell.classList.add('goal');
              cell.textContent = 'üèÅ';
            }
            if(r === player.row && c === player.col){
              cell.classList.add('player');
              cell.textContent = 'üß≠';
            }
            mazeBoard.appendChild(cell);
          }
        }
      }

      function resetGame(){
        active = false;
        moves = 0;
        player = { ...start };
        celebrate.innerHTML = '';
        document.body.classList.remove('win-mode');
        startBtn.style.display = 'inline-flex';
        startBtn.disabled = false;
        startBtn.textContent = 'Start';
        resetBtn.style.display = 'none';
        gameArea.style.display = 'none';
        setStatus('ok', 'Press Start, then use the arrow keys to explore the maze.');
      }

      function startGame(){
        active = true;
        moves = 0;
        pickMaze();
        findPoints();
        player = { ...start };
        celebrate.innerHTML = '';
        document.body.classList.remove('win-mode');
        startBtn.style.display = 'none';
        resetBtn.style.display = 'inline-flex';
        gameArea.style.display = 'block';
        setStatus('ok', 'Find the flag. Every move counts!');
        renderMaze();
        if(typeof requestAnimationFrame === 'function'){
          requestAnimationFrame(() => window.GameUI?.fitLettersFor?.(arrowRow));
        }
      }

      function isWalkable(row, col){
        if(row < 0 || col < 0) return false;
        if(row >= mazeMap.length || col >= mazeMap[0].length) return false;
        return mazeMap[row][col] !== '#';
      }

      function handleMove(direction){
        if(!active){
          setStatus('bad', 'Press Start to begin the maze.');
          return;
        }
        const delta = {
          up: { row: -1, col: 0 },
          down: { row: 1, col: 0 },
          left: { row: 0, col: -1 },
          right: { row: 0, col: 1 }
        }[direction];
        if(!delta) return;

        const nextRow = player.row + delta.row;
        const nextCol = player.col + delta.col;

        if(!isWalkable(nextRow, nextCol)){
          soundWall.currentTime = 0;
          window.GameSound.play(soundWall);
          setStatus('bad', 'Bonk! That is a wall. Try another direction.');
          return;
        }

        player = { row: nextRow, col: nextCol };
        moves += 1;
        soundMove.currentTime = 0;
        window.GameSound.play(soundMove);
        renderMaze();
        setStatus('ok', 'Nice move! Keep going.');

        if(player.row === goal.row && player.col === goal.col){
          finishGame();
        }
      }

      function finishGame(){
        active = false;
        document.body.classList.add('win-mode');
        setStatus('ok', `You escaped in <strong>${moves}</strong> moves!`);
        const winMarkup = `
          <div class="celebration">
            <div class="text-2xl font-extrabold uppercase tracking-[0.2em] text-cyan-700">Maze Complete</div>
            <div class="text-lg font-semibold text-slate-700">Great navigating! You found the flag.</div>
            <div class="text-4xl leading-none">üèÅ‚ú®üß≠</div>
          </div>
        `;
        celebrate.innerHTML = winMarkup;
        soundWin.currentTime = 0;
        window.GameSound.play(soundWin);
        if(window.GameCelebration){
          window.GameCelebration.show({
            content: winMarkup,
            onPlayAgain: () => {
              resetGame();
              startGame();
            },
            focusTarget: resetBtn,
            initialFocus: 'playAgain'
          });
        } else {
          resetBtn.focus();
        }
        window.scrollTo({ top: 0, behavior: (window.GameUI?.scrollBehavior?.() ?? 'smooth') });
      }

      function handleKeydown(event){
        const keyMap = {
          ArrowUp: 'up',
          ArrowDown: 'down',
          ArrowLeft: 'left',
          ArrowRight: 'right'
        };
        const direction = keyMap[event.key];
        if(!direction) return;
        if(active){
          event.preventDefault();
        }
        handleMove(direction);
      }

      function handleButtonPress(event){
        const direction = event.currentTarget.dataset.dir;
        handleMove(direction);
      }

      findPoints();
      renderMaze();
      resetGame();

      startBtn.addEventListener('click', () => {
        if(active) return;
        startGame();
      });

      resetBtn.addEventListener('click', () => {
        resetGame();
        startGame();
      });

      window.addEventListener('keydown', handleKeydown);

      document.querySelectorAll('.dpad-btn').forEach((button) => {
        button.addEventListener('click', handleButtonPress);
      });

      window.GameUI?.fitLettersFor?.(arrowRow);
    })();
  </script>
{{ end }}
